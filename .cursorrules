# SCUM Client - 本地规则

## 功能概述
SCUM游戏服务器机器人客户端，通过PaddleOCR识别、剪贴板操作和键盘模拟实现游戏服务器的自动化管理。

## 核心架构
- **主循环**: main.go 无限循环调用 server.Start()
- **状态检测**: 通过PaddleOCR识别游戏登录、加载、聊天界面状态
- **指令执行**: 通过剪贴板操作发送游戏指令并获取返回结果
- **定时任务**: 定期获取玩家信息、载具信息、领地信息等
- **OCR服务**: 基于PaddleOCR的本地HTTP服务，提供图片文字识别

## PaddleOCR 集成架构 (新增)

### 1. OCR 环境自动化
**核心文件**:
- `ocr_setup.bat`: 自动化环境设置脚本
- `ocr_server.py`: PaddleOCR HTTP 服务
- `util/ocr_service.go`: OCR 服务管理模块

**功能特性**:
- 自动创建 Python 虚拟环境
- 自动下载和安装 PaddleOCR 及依赖
- 自动下载指定的英文识别模型 (en_PP-OCRv4_mobile_rec)
- 服务自动启动和生命周期管理

### 2. OCR 服务架构
```
┌─────────────────┐    HTTP API    ┌──────────────────┐
│   Go Client     │ ──────────────→ │  Python OCR      │
│ (scum_client)   │ ←────────────── │  Service         │
└─────────────────┘    JSON        └──────────────────┘
                                           │
                                           ▼
                                   ┌──────────────────┐
                                   │   PaddleOCR      │
                                   │   Model          │
                                   └──────────────────┘
```

### 3. API 接口设计
**请求格式**:
```json
{
    "Base64": "图片的Base64编码",
    "target_text": "期望识别的文本" // 可选
}
```

**响应格式**:
```json
{
    "code": 100,           // 100=成功找到目标文字, 200=识别到文字但非目标, 其他=错误
    "data": "识别结果",
    "message": "状态信息"
}
```

### 4. 模型配置
- **模型**: en_PP-OCRv4_mobile_rec (英文移动版)
- **下载链接**: https://paddle-model-ecology.bj.bcebos.com/paddlex/official_inference_model/paddle3.0.0/en_PP-OCRv4_mobile_rec_infer.tar
- **存储路径**: `paddle_models/en_PP-OCRv4_mobile_rec_infer/`
- **特点**: 轻量级、适合SCUM英文界面识别

## 最新优化内容 (包含OCR升级)

### 1. OCR 服务管理
**新增功能**:
- `EnsureOCRService()`: 确保OCR服务运行
- `StartOCRService()`: 启动OCR服务
- `StopOCRService()`: 停止OCR服务
- `IsOCRServiceRunning()`: 检查服务状态
- `GetOCRServiceStatus()`: 获取详细状态

**生命周期管理**:
- 程序启动时自动检查并启动OCR服务
- 程序退出时自动清理OCR进程
- 服务异常时自动重启机制

### 2. 图片识别优化
**函数升级**:
- `ExtractTextFromSpecifiedAreaAndValidateThreeTimes()`: 支持目标文字参数
- `ExtractTextFromArea()`: 新增通用文字提取函数

**识别策略**:
- 支持目标文字精确匹配
- 忽略大小写和空格的模糊匹配
- 超时机制和重试策略
- 详细的识别结果日志

### 3. 环境自动化
**ocr_setup.bat 功能**:
- 检测Python环境
- 创建虚拟环境
- 安装PaddleOCR和依赖包
- 下载并解压模型文件
- 环境验证和错误处理

**目录结构**:
```
scum_client/
├── ocr_env/                 # Python虚拟环境
├── paddle_models/           # PaddleOCR模型
├── logs/                    # 日志文件
│   ├── scum_client_*.log   # 主程序日志
│   └── ocr_service.log     # OCR服务日志
├── ocr_setup.bat           # 环境设置脚本
├── ocr_server.py           # OCR服务
├── start.bat               # 程序启动脚本
└── scum_client.exe         # 主程序
```

## 日志系统完善

### 1. 日志文件结构
```
logs/
├── scum_client_2024-01-01.log    # 主程序日志
└── ocr_service.log                # OCR服务日志
```

### 2. 日志级别和内容
- **INFO**: 一般操作信息
- **ERROR**: 错误信息
- **DEBUG**: 调试信息
- **OCR**: OCR识别过程和结果

## 使用指南

### 1. 首次安装
```bash
# 1. 运行环境设置 (会自动下载模型)
ocr_setup.bat

# 2. 编译程序
go build -o scum_client.exe

# 3. 启动程序
start.bat
```

### 2. 日常使用
```bash
# 直接启动 (会自动检查OCR环境)
start.bat

# 或者直接运行
scum_client.exe
```

### 3. 故障排查
- 查看主程序日志: `logs/scum_client_*.log`
- 查看OCR服务日志: `logs/ocr_service.log`
- 检查OCR环境: 确认 `ocr_env/` 和 `paddle_models/` 目录存在
- 手动测试OCR服务: 访问 `http://127.0.0.1:1224/health`

## 性能优化

### OCR 识别优化
- 灰度图片处理减少数据量
- 区域截图减少识别范围
- 目标文字参数提高匹配精度
- HTTP连接池和超时控制

### 服务管理优化
- 服务状态缓存减少检查频率
- 进程管理避免僵尸进程
- 优雅退出确保资源清理
- 自动重启提高服务可用性

## 依赖环境

### Python 依赖
- Python 3.8+
- PaddleOCR
- Flask
- Pillow
- requests

### Go 依赖
- github.com/go-vgo/robotgo
- github.com/atotto/clipboard
- github.com/vova616/screenshot
- gopkg.in/yaml.v3

## 安全注意事项
- OCR服务仅绑定本地127.0.0.1，不对外开放
- 图片数据仅在内存中处理，不持久化存储
- 模型文件本地存储，避免网络依赖
- 进程隔离确保服务安全

## 扩展性设计
- 支持多种OCR模型切换
- 可配置的识别参数
- 模块化的服务管理
- 标准化的API接口

## 兼容性说明
- 主要针对Windows系统优化
- 支持Python 3.8+ 版本
- 兼容不同分辨率的显示器
- 支持SCUM游戏的英文界面

这次升级完全替换了原有的OCR系统，采用了更先进的PaddleOCR技术栈，提供了更好的识别精度和系统集成度。

## 关键函数说明

### `Send()` 函数优化
```go
// 新增步骤：
1. 输入验证和聊天框状态确认
2. 剪贴板完全清空并验证
3. 指令写入剪贴板并验证
4. 发送指令
5. 根据指令类型等待响应并多次尝试读取
```

### `ensureChatBoxActive()` 函数
```go
// 功能：
- 确保聊天框处于激活状态
- 自动切换到GLOBAL聊天模式
- 验证聊天界面状态
```

### `setWindowPositionOnce()` 函数
```go
// 功能：
- 缓存窗口位置，避免重复设置
- 只在位置不正确时才调整
- 增加窗口稳定等待时间
```

## 指令处理策略

### 需要等待响应的指令
```go
updateClipboard = map[string]bool{
    "#listflags 1 true":         true,
    "#ListSpawnedVehicles true": true, 
    "#dumpallsquadsinfolist":    true,
    "#ListPlayers true":         true, // 新增
}
```

### 等待时间配置
- `#ListPlayers true`: 2秒
- `#ListSpawnedVehicles true`: 1.5秒  
- `#dumpallsquadsinfolist`: 3秒
- `#listflags X true`: 2秒

## 定时任务调度
- **每15次循环** (~2.25秒): 获取载具和玩家信息
- **每150次循环** (~22.5秒): 获取领地和队伍信息
- **实时**: 处理服务器下发的指令

## 调试和日志
- 增加详细的控制台输出
- 标记关键操作步骤
- 记录响应数据长度
- 输出错误详情和重试信息

## 安全注意事项
- 避免敏感坐标信息泄漏到剪贴板
- 确保指令执行的原子性
- 防止恶意指令注入
- 控制指令执行频率

## 性能优化
- 减少不必要的窗口操作
- 优化OCR识别调用频率
- 合理设置等待时间
- 缓存机制减少重复操作

## 测试要点
1. 长时间运行稳定性
2. 不同游戏状态切换的处理
3. 网络异常时的恢复能力
4. 剪贴板冲突处理
5. 窗口被其他程序覆盖时的处理 